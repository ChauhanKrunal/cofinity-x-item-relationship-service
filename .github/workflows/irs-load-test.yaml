name: IRS Load Test

on:
  workflow_dispatch: # Trigger manually
    inputs:
      irs-host:
        type: choice
        description: IRS environment to test
        default: 'https://irs.int.demo.catena-x.net'
        required: true
        options:
          - 'https://irs.int.demo.catena-x.net'
          - 'https://irs.dev.demo.catena-x.net'
      test-cycles:
        type: number
        description: Number of Test Cycles
        default: 20
        required: false

jobs:
  jmeter-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run JMeter tests
        env:
          IRS_HOST: ${{ github.event.inputs.irs-host || 'https://irs.int.demo.catena-x.net' }}
          KEYCLOAK_HOST: ${{ secrets.KEYCLOAK_OAUTH2_CLIENT_TOKEN_URI }}
          KEYCLOAK_CLIENT_ID: ${{ secrets.KEYCLOAK_OAUTH2_CLIENT_ID }}
          KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_OAUTH2_CLIENT_SECRET }}
          TEST_CYCLES: ${{ github.event.inputs.test-cycles || '20' }}
        run: |
          jmeter -n -t IRS-Load-Test-Scenario.jmx -l log.jtl -e -o logs\

      - name: Archive Report
        # TODO

  gatling-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Gatling tests
        env:
          KEYCLOAK_HOST: ${{ secrets.KEYCLOAK_OAUTH2_CLIENT_TOKEN_URI }}
          KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_OAUTH2_CLIENT_ID }}
          KEYCLOAK_CLIENT_ID: ${{ secrets.KEYCLOAK_OAUTH2_CLIENT_ID }}
          IRS_HOST: ${{ github.event.inputs.irs-host || 'https://irs.int.demo.catena-x.net' }}
          TEST_CYCLES: ${{ github.event.inputs.test-cycles || '20' }}
        run: |
          mvn gatling:test -pl irs-load-tests

      - name: Archive Report
        # TODO

